# Servicios de API - Arquitectura Escalable

## üèóÔ∏è **Arquitectura General**

Este sistema implementa una arquitectura de servicios organizados por dominio, proporcionando una capa de abstracci√≥n entre los componentes de React y la API del servidor.

```
src/
‚îú‚îÄ‚îÄ lib/
‚îÇ   ‚îú‚îÄ‚îÄ api.ts                 # Cliente HTTP base con autenticaci√≥n autom√°tica
‚îÇ   ‚îî‚îÄ‚îÄ services/              # Servicios organizados por dominio
‚îÇ       ‚îú‚îÄ‚îÄ auth.service.ts    # Autenticaci√≥n y usuarios
‚îÇ       ‚îú‚îÄ‚îÄ sales.service.ts   # Ventas y transacciones
‚îÇ       ‚îú‚îÄ‚îÄ clients.service.ts # Gesti√≥n de clientes
‚îÇ       ‚îú‚îÄ‚îÄ suppliers.service.ts # Gesti√≥n de proveedores
‚îÇ       ‚îú‚îÄ‚îÄ operators.service.ts # Gesti√≥n de operadores
‚îÇ       ‚îú‚îÄ‚îÄ classifications.service.ts # Clasificaciones y categor√≠as
‚îÇ       ‚îî‚îÄ‚îÄ payments.service.ts # Pagos y transacciones
‚îú‚îÄ‚îÄ hooks/
‚îÇ   ‚îú‚îÄ‚îÄ useApi.ts              # Hook base para peticiones HTTP
‚îÇ   ‚îî‚îÄ‚îÄ services/              # Hooks espec√≠ficos para cada servicio
‚îî‚îÄ‚îÄ components/                 # Componentes que usan los hooks
```

## üöÄ **Caracter√≠sticas Principales**

### **1. Cliente HTTP Inteligente (`api.ts`)**
- ‚úÖ Autenticaci√≥n autom√°tica con JWT
- ‚úÖ Manejo autom√°tico de errores 401 (redirige a login)
- ‚úÖ Tipado TypeScript completo
- ‚úÖ Headers autom√°ticos para todas las peticiones

### **2. Servicios Organizados por Dominio**
- ‚úÖ **Separaci√≥n de responsabilidades**: Cada servicio maneja un dominio espec√≠fico
- ‚úÖ **Interfaces tipadas**: Todas las operaciones tienen tipos TypeScript
- ‚úÖ **Consistencia**: Misma estructura para todos los servicios
- ‚úÖ **Reutilizaci√≥n**: Los servicios pueden ser usados en m√∫ltiples componentes

### **3. Hooks Personalizados (`useApi`)**
- ‚úÖ **Estados integrados**: `loading`, `error`, `data`
- ‚úÖ **Manejo de errores**: Callbacks de √©xito y error
- ‚úÖ **Reintentos autom√°ticos**: L√≥gica de reintento integrada
- ‚úÖ **Optimizaci√≥n**: Prevenci√≥n de re-renders innecesarios

## üìö **Uso de Servicios**

### **Importaci√≥n de Servicios**

```typescript
// Importar un servicio espec√≠fico
import { authService } from "../lib/services/auth.service";
import { salesService } from "../lib/services/sales.service";

// O importar todos los servicios
import * as services from "../lib/services";
```

### **Uso Directo de Servicios**

```typescript
// En componentes o funciones
const handleLogin = async (credentials: LoginCredentials) => {
  try {
    const response = await authService.login(credentials);
    if (response.data) {
      // Manejar respuesta exitosa
      console.log(response.data.user);
    }
  } catch (error) {
    // Manejar error
    console.error("Login failed:", error);
  }
};
```

## üé£ **Uso de Hooks de Servicios**

### **Hook de Autenticaci√≥n**

```typescript
import { useAuth } from "../hooks/services/useAuth";

function LoginForm() {
  const { login } = useAuth();
  
  const handleSubmit = async (formData: LoginCredentials) => {
    await login.execute(formData);
  };

  return (
    <form onSubmit={handleSubmit}>
      {/* Formulario */}
      {login.loading && <span>Cargando...</span>}
      {login.error && <span className="error">{login.error}</span>}
    </form>
  );
}
```

### **Hook de Ventas**

```typescript
import { useSales } from "../hooks/services/useSales";

function SalesList() {
  const { getAll, getStats } = useSales();
  
  useEffect(() => {
    getAll.execute();
    getStats.execute();
  }, []);

  if (getAll.loading) return <div>Cargando ventas...</div>;
  if (getAll.error) return <div>Error: {getAll.error}</div>;

  return (
    <div>
      {getAll.data?.sales?.map(sale => (
        <SaleCard key={sale.id} sale={sale} />
      ))}
    </div>
  );
}
```

### **Hook de Clientes**

```typescript
import { useClients } from "../hooks/services/useClients";

function ClientForm() {
  const { create, update } = useClients();
  
  const handleSubmit = async (clientData: CreateClientData) => {
    if (isEditing) {
      await update.execute(clientId, clientData);
    } else {
      await create.execute(clientData);
    }
  };

  return (
    <form onSubmit={handleSubmit}>
      {/* Formulario */}
      {(create.loading || update.loading) && <span>Guardando...</span>}
      {(create.error || update.error) && (
        <span className="error">{create.error || update.error}</span>
      )}
    </form>
  );
}
```

## üîß **Configuraci√≥n y Personalizaci√≥n**

### **Variables de Entorno**

```bash
# .env
VITE_API_URL=http://localhost:3001
```

### **Personalizaci√≥n de Headers**

```typescript
// En api.ts
private getHeaders(): HeadersInit {
  const token = localStorage.getItem("auth_token");
  const headers: HeadersInit = {
    "Content-Type": "application/json",
    "X-Custom-Header": "value", // Headers personalizados
  };

  if (token) {
    headers.Authorization = `Bearer ${token}`;
  }

  return headers;
}
```

### **Manejo de Errores Personalizado**

```typescript
// En useApi.ts
const execute = useCallback(
  async (...args: any[]) => {
    setState(prev => ({ ...prev, loading: true, error: null }));
    
    try {
      const response = await apiCall(...args);
      
      if (response.data) {
        setState(prev => ({ ...prev, data: response.data, loading: false }));
        options.onSuccess?.(response.data);
      } else {
        throw new Error(response.message || "No data received");
      }
    } catch (error) {
      const errorMessage = error instanceof Error ? error.message : "An error occurred";
      
      // L√≥gica personalizada de manejo de errores
      if (errorMessage.includes("Network")) {
        setState(prev => ({ ...prev, error: "Error de conexi√≥n", loading: false }));
      } else {
        setState(prev => ({ ...prev, error: errorMessage, loading: false }));
      }
      
      options.onError?.(errorMessage);
    }
  },
  [apiCall, options.onSuccess, options.onError]
);
```

## üìà **Escalabilidad y Mantenimiento**

### **Agregar Nuevos Servicios**

1. **Crear el archivo de servicio**:
```typescript
// src/lib/services/new-service.service.ts
import { api } from "../api";

export interface NewEntity {
  id: string;
  name: string;
  // ... otras propiedades
}

export const newService = {
  getAll: () => api.get<{ entities: NewEntity[] }>("/api/new-entities"),
  getById: (id: string) => api.get<NewEntity>(`/api/new-entities/${id}`),
  create: (data: Partial<NewEntity>) => 
    api.post<{ message: string; entity: NewEntity }>("/api/new-entities", data),
  // ... otros m√©todos
};
```

2. **Crear el hook correspondiente**:
```typescript
// src/hooks/services/useNewService.ts
import { useApi } from "../useApi";
import { newService } from "../../lib/services/new-service.service";

export const useNewService = () => {
  const getAll = useApi(newService.getAll);
  const getById = useApi(newService.getById);
  const create = useApi(newService.create);
  
  return { getAll, getById, create };
};
```

3. **Exportar desde el √≠ndice**:
```typescript
// src/lib/services/index.ts
export * from "./new-service.service";

// src/hooks/services/index.ts
export * from "./useNewService";
```

### **Patrones de Uso Recomendados**

#### **1. Manejo de Estados de Carga**
```typescript
function DataComponent() {
  const { getAll } = useSales();
  
  // Estado de carga global
  if (getAll.loading) {
    return <LoadingSpinner />;
  }
  
  // Estado de error
  if (getAll.error) {
    return <ErrorMessage error={getAll.error} onRetry={() => getAll.execute()} />;
  }
  
  // Datos cargados
  return <DataList data={getAll.data} />;
}
```

#### **2. Operaciones con Callbacks**
```typescript
function CreateForm() {
  const { create } = useSales();
  
  const handleSubmit = async (formData: CreateSaleData) => {
    await create.execute(formData, {
      onSuccess: (data) => {
        toast.success("Venta creada exitosamente");
        navigate(`/sales/${data.sale.id}`);
      },
      onError: (error) => {
        toast.error(`Error al crear venta: ${error}`);
      }
    });
  };
}
```

#### **3. Reutilizaci√≥n de Servicios**
```typescript
// En m√∫ltiples componentes
function SalesDashboard() {
  const { getStats, getSalesOverview } = useSales();
  // ... l√≥gica del dashboard
}

function SalesReport() {
  const { getStats, getSalesOverview } = useSales();
  // ... l√≥gica del reporte
}
```

## üß™ **Testing**

### **Mocking de Servicios**

```typescript
// __mocks__/services/auth.service.ts
export const authService = {
  login: jest.fn(),
  logout: jest.fn(),
  getCurrentUser: jest.fn(),
};

// En tests
jest.mock("../lib/services/auth.service");
import { authService } from "../lib/services/auth.service";

test("should handle login success", async () => {
  authService.login.mockResolvedValue({
    data: { user: mockUser, token: "mock-token" }
  });
  
  // ... test logic
});
```

### **Testing de Hooks**

```typescript
import { renderHook, act } from "@testing-library/react";
import { useSales } from "../hooks/services/useSales";

test("should fetch sales on mount", async () => {
  const { result } = renderHook(() => useSales());
  
  await act(async () => {
    await result.current.getAll.execute();
  });
  
  expect(result.current.getAll.data).toBeDefined();
});
```

## üö® **Soluci√≥n de Problemas Comunes**

### **Error 401 - No autorizado**
- Verificar que el token est√© presente en localStorage
- El sistema redirige autom√°ticamente a login
- Verificar que el token no haya expirado

### **Error de CORS**
- Verificar la URL de la API en las variables de entorno
- Asegurar que el servidor permita requests desde el origen correcto

### **Datos no se cargan**
- Verificar que el hook est√© siendo llamado con `.execute()`
- Revisar la consola para errores de red
- Verificar que el servicio est√© exportado correctamente

### **Re-renders excesivos**
- Usar `useCallback` para funciones que se pasan como props
- Verificar que las dependencias de `useEffect` sean correctas
- Usar `React.memo` para componentes que no necesitan re-renderizarse

## üìö **Recursos Adicionales**

- [Documentaci√≥n de React Hooks](https://react.dev/reference/react/hooks)
- [TypeScript Handbook](https://www.typescriptlang.org/docs/)
- [Fetch API](https://developer.mozilla.org/en-US/docs/Web/API/Fetch_API)
- [JWT Authentication](https://jwt.io/introduction)

---

**¬øNecesitas ayuda?** Revisa la consola del navegador para errores espec√≠ficos o consulta la documentaci√≥n de la API del servidor.
